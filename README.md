# WeChat â†’ Notion AIO (Bilingual)

**Languages / è¯­è¨€åˆ‡æ¢**: [English](#english) | [ä¸­æ–‡](#chinese)

---

<a id="english"></a>

# WeChat â†’ Notion | Competitions & Events Ingestion (AIO)

Aggregate WeChat Official Accounts / websites into **Notion**:
- Auto-fetch (plug in **WeWe RSS** if you like)
- Rule-based scoring (competitions / events / negative blocks)
- Write to **Events** database & generate a daily brief (**Daily Briefs**)
- **Runs twice every day at 14:30 / 19:30 (UTC+8)** via GitHub Actions

> Fits the all-in-one page: **Sources / Events / Rules** (inline databases) + **Daily Briefs** (child page).

---

## âœ¨ Features
- **Rule scoring**: supports `TRIGGERS_COMP / TRIGGERS_EVENT / NEGATIVE / MIN_SCORE â€¦`
- **De-dup**: same `Link` wonâ€™t be created twice
- **Daily brief**: `ğŸ“… YYYY-MM-DD Competition/Event Brief`
- **Reliability**: retry with exponential backoff; fallback parsing when RSS fails
- **Optional WeWe refresh**: `wewerss-refresh.yml` triggers `?update=true`

---

## ğŸ§± Notion Schema
**Sources**
- `Name(title)` / `FeedURL(url)` / `Enabled(checkbox)`

**Events**
- `Name(title)` / `Type(select: Competition, Event)` / `Source(rich_text)`  
- `Published(date)` / `Deadline(date)` / `Score(number)`  
- `Link(url)` / `Summary(rich_text)`

**Rules**
- `Name(title)` / `Key(select: TRIGGERS_COMP, TRIGGERS_EVENT, NEGATIVE, PRIZE, ORG_AUTH, ONLINE, AUDIENCE, MIN_SCORE)`  
- `Pattern(rich_text)` / `Weight(number)` / `HardBlock(checkbox)` / `Enabled(checkbox)`

**Daily Briefs**
- A parent page for generated briefs

> All four objects must be **shared to your Integration (Can edit)**.

---

## ğŸ” Required GitHub Secrets
- `NOTION_TOKEN` â€“ Notion internal integration token (`secret_â€¦`)
- `NOTION_SOURCES_DB` â€“ Sources database ID
- `NOTION_DB_ID` â€“ Events database ID
- `NOTION_RULES_DB` â€“ Rules database ID
- `NOTION_DAILY_PARENT` â€“ Daily Briefs parent page ID

**(Optional Repo Variables)** `TZ=Asia/Shanghai`  
**(Optional for WeWe refresh)** `WEWE_BASE`, `WEWE_FEED_IDS`

---

## ğŸ—‚ Project Layout
```
.
â”œâ”€ src/
â”‚  â”œâ”€ pipeline.py        # Read Sources â†’ score â†’ write Events â†’ build brief
â”‚  â”œâ”€ fetch.py           # RSS/Atom first; fallback to HTML parsing
â”‚  â”œâ”€ rules.py           # Rule compilation & scoring
â”‚  â”œâ”€ notion_util.py     # Notion API wrapper + retries
â”‚  â””â”€ config.py          # Env loader
â”œâ”€ requirements.txt
â””â”€ .github/workflows/
   â”œâ”€ notion-pipeline.yml       # Main pipeline (14:30 / 19:30 UTC+8)
   â””â”€ wewerss-refresh.yml       # Optional: trigger WeWe `?update=true`
```

---

## ğŸš€ Quick Start
1. **Notion**: create/verify the four objects (Sources/Events/Rules/Daily Briefs), then **Share** them to your Integration (**Can edit**).  
2. **Sources**: add a test row  
   - `Name=Sample`, `FeedURL=(RSS/Atom or web page)`, `Enabled=âœ…`  
   - Prefer an `.atom` generated by **WeWe RSS**; you may append `title_include` / `title_exclude` filters to the URL.  
3. **GitHub Secrets**: fill in the 5 required items above.  
4. **First run**  
   - Actions â†’ `notion-pipeline (UTC+8 14:30 / 19:30)` â†’ **Run workflow**  
   - (Optional) `wewerss-refresh` â†’ **Run workflow** (needs `WEWE_BASE`)

After it finishes, you should see new items in **Events**, and a new brief page under **Daily Briefs**.

---

## â± Scheduling (Cron)
- `notion-pipeline.yml`:
  - `30 6 * * *` â†’ **14:30 UTC+8**
  - `30 11 * * *` â†’ **19:30 UTC+8**
- GitHub pauses cron if the repo is **inactive for 60 days**; any push or manual run will resume it.
- For a third time (e.g., **23:59 +8**):
  - Enable `wewerss-refresh.yml` (set `WEWE_BASE`) to trigger WeWe at 15:59 UTC; or
  - Widen WeWeâ€™s `CRON_EXPRESSION` (may over-trigger; use with care).

---

## ğŸ©º Troubleshooting
- **No data inserted**:
  - Is the source **Enabled** and the FeedURL accessible?
  - Is `MIN_SCORE` too high? (try 2â€“3)
  - Does the Integration have **Can edit** permissions?
- **Duplicates/noisy**: raise `NEGATIVE` weights and set **HardBlock=âœ…**; increase `MIN_SCORE`; or use `title_include/exclude` in the feed URL.
- **WeWe not updating**: confirm `CRON_EXPRESSION` is applied (Redeploy), and try `â€¦/feeds/all.atom?update=true`.

---

## ğŸ“ Run locally (optional)
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

export NOTION_TOKEN=secret_xxx
export NOTION_SOURCES_DB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_DB_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_RULES_DB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_DAILY_PARENT=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

python -m src.pipeline
```

---

## ğŸ”’ Security
- **Never** commit tokens/IDs; put them in **GitHub Secrets** only.
- To revoke: remove the Integration from Notion **Connections** or reset the token.




---

<a id="chinese"></a>

# WeChat â†’ Notionï½œç«èµ› & æ´»åŠ¨ä¸€ä½“åŒ–é‡‡é›†ï¼ˆAIOï¼‰

æŠŠå¾®ä¿¡å…¬ä¼—å· / ç½‘ç«™ç­‰ä¿¡æ¯æºæ±‡æ€»åˆ° **Notion**ï¼š
- è‡ªåŠ¨æŠ“å–ï¼ˆå¯æ¥å…¥ **WeWe RSS**ï¼‰
- è§„åˆ™æ‰“åˆ†ï¼ˆç«èµ› / æ´»åŠ¨ / è´Ÿå‘å±è”½ï¼‰
- å†™å…¥ **Events** æ•°æ®åº“ & ç”Ÿæˆæ¯æ—¥ç®€æŠ¥ï¼ˆ**Daily Briefs**ï¼‰
- **æ¯å¤© UTC+8 çš„ 14:30 / 19:30** è‡ªåŠ¨è¿è¡Œï¼ˆGitHub Actionsï¼‰

> é€‚é…ä¸€ä½“åŒ–é¡µé¢ï¼š**Sources / Events / Rules**ï¼ˆå†…è”æ•°æ®åº“ï¼‰+ **Daily Briefs**ï¼ˆå­é¡µé¢ï¼‰ã€‚

---

## âœ¨ ç‰¹æ€§
- **æŒ‰è§„åˆ™æ‰“åˆ†**ï¼šæ”¯æŒ `TRIGGERS_COMP / TRIGGERS_EVENT / NEGATIVE / MIN_SCORE â€¦`
- **å»é‡å†™å…¥**ï¼šåŒä¸€ `Link` ä¸é‡å¤åˆ›å»º
- **è‡ªåŠ¨ç®€æŠ¥**ï¼š`ğŸ“… YYYY-MM-DD ç«èµ›/æ´»åŠ¨ç®€æŠ¥`
- **ç¨³å®šæ€§**ï¼šNotion API æŒ‡æ•°é€€é¿é‡è¯•ï¼›RSS å¤±è´¥å›è½ç½‘é¡µè§£æ
- **å¯é€‰ WeWe åˆ·æ–°**ï¼šé…åˆ `wewerss-refresh.yml` å®šæ—¶è§¦å‘ `?update=true`

---

## ğŸ§± Notion æ•°æ®åº“ç»“æ„
**Sources**
- `Name(title)` / `FeedURL(url)` / `Enabled(checkbox)`

**Events**
- `Name(title)` / `Type(selectï¼šå« ç«èµ›ã€æ´»åŠ¨)` / `Source(rich_text)`  
- `Published(date)` / `Deadline(date)` / `Score(number)`  
- `Link(url)` / `Summary(rich_text)`

**Rules**
- `Name(title)` / `Key(selectï¼šTRIGGERS_COMP, TRIGGERS_EVENT, NEGATIVE, PRIZE, ORG_AUTH, ONLINE, AUDIENCE, MIN_SCORE)`  
- `Pattern(rich_text)` / `Weight(number)` / `HardBlock(checkbox)` / `Enabled(checkbox)`

**Daily Briefs**
- å­é¡µé¢ï¼Œä½œä¸ºç®€æŠ¥çˆ¶é¡µé¢

> ä»¥ä¸Šå››ä¸ªå¯¹è±¡éœ€ **Share â†’ Add connections â†’ ä½ çš„ Integrationï¼ˆCan editï¼‰**ã€‚

---

## ğŸ” å¿…å¡« GitHub Secrets
- `NOTION_TOKEN` â€“ Notion å†…éƒ¨é›†æˆ tokenï¼ˆ`secret_â€¦`ï¼‰
- `NOTION_SOURCES_DB` â€“ Sources æ•°æ®åº“ ID
- `NOTION_DB_ID` â€“ Events æ•°æ®åº“ ID
- `NOTION_RULES_DB` â€“ Rules æ•°æ®åº“ ID
- `NOTION_DAILY_PARENT` â€“ Daily Briefs çˆ¶é¡µé¢ ID

**ï¼ˆå¯é€‰ Repo Variablesï¼‰** `TZ=Asia/Shanghai`  
**ï¼ˆå¯é€‰ï¼Œç”¨äºåˆ·æ–° WeWeï¼‰** `WEWE_BASE`ã€`WEWE_FEED_IDS`

---

## ğŸ—‚ ç›®å½•ç»“æ„
```
.
â”œâ”€ src/
â”‚  â”œâ”€ pipeline.py        # è¯»å– Sources â†’ è¯„åˆ† â†’ å†™å…¥ Events â†’ ç”Ÿæˆç®€æŠ¥
â”‚  â”œâ”€ fetch.py           # RSS/Atom ä¼˜å…ˆï¼›å¤±è´¥å›è½é¡µé¢è§£æ
â”‚  â”œâ”€ rules.py           # è§„åˆ™ç¼–è¯‘ä¸æ‰“åˆ†
â”‚  â”œâ”€ notion_util.py     # Notion API å°è£… + é‡è¯•
â”‚  â””â”€ config.py          # è¯»å–ç¯å¢ƒå˜é‡
â”œâ”€ requirements.txt
â””â”€ .github/workflows/
   â”œâ”€ notion-pipeline.yml       # ä¸»æµç¨‹ï¼ˆ14:30 / 19:30 UTC+8ï¼‰
   â””â”€ wewerss-refresh.yml       # å¯é€‰ï¼šè§¦å‘ WeWe `?update=true`
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹
1. **Notion**ï¼šåˆ›å»º/ç¡®è®¤å››ä¸ªå¯¹è±¡ï¼ˆSources/Events/Rules/Daily Briefsï¼‰ï¼Œå­—æ®µå¦‚ä¸Šï¼›**Share** ç»™ Integrationï¼ˆCan editï¼‰ã€‚  
2. **Sources**ï¼šæ–°å¢ä¸€è¡Œæµ‹è¯•æº  
   - `Name=ç¤ºä¾‹`ï¼Œ`FeedURL=ï¼ˆRSS/Atom é“¾æ¥æˆ–ç½‘é¡µï¼‰`ï¼Œ`Enabled=âœ…`  
   - æ¨èä½¿ç”¨ **WeWe RSS** ç”Ÿæˆçš„ `.atom`ï¼›å¯åœ¨ URL ä¸Šè¿½åŠ  `title_include` / `title_exclude` è¿‡æ»¤ã€‚  
3. **GitHub Secrets**ï¼šå¡«å¥½ä¸Šé¢çš„ 5 ä¸ªå¿…å¡«é¡¹ã€‚  
4. **é¦–æ¬¡æ‰‹åŠ¨è¿è¡Œ**  
   - Actions â†’ `notion-pipeline (UTC+8 14:30 / 19:30)` â†’ **Run workflow**  
   - ï¼ˆå¯é€‰ï¼‰`wewerss-refresh` â†’ **Run workflow**ï¼ˆéœ€å…ˆè®¾ç½® `WEWE_BASE`ï¼‰

è¿è¡Œå®Œæˆåï¼Œåœ¨ **Events** å¯è§æ–°å¢æ¡ç›®ï¼Œåœ¨ **Daily Briefs** ä¸‹å¯è§å½“å¤©ç®€æŠ¥ã€‚

---

## â± å®šæ—¶ï¼ˆCronï¼‰
- `notion-pipeline.yml`ï¼š
  - `30 6 * * *` â†’ **14:30 UTC+8**
  - `30 11 * * *` â†’ **19:30 UTC+8**
- GitHub å®šæ—¶åœ¨ä»“åº“ **60 å¤©æ— æ´»åŠ¨**æ—¶ä¼šæš‚åœï¼›ä»»æ„ push æˆ–æ‰‹åŠ¨ Run æ¢å¤ã€‚
- éœ€è¦ç¬¬ä¸‰ä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚ **23:59 +8**ï¼‰ï¼š
  - æ‰“å¼€ `wewerss-refresh.yml`ï¼ˆè®¾ç½® `WEWE_BASE`ï¼‰ï¼Œåœ¨ 15:59 UTC è§¦å‘ WeWe åˆ·æ–°ï¼›æˆ–
  - å°† WeWe çš„ `CRON_EXPRESSION` é…æˆæ›´å®½è¡¨è¾¾å¼ï¼ˆä¼šå¤šåˆ·ï¼Œè°¨æ…ï¼‰ã€‚

---

## ğŸ©º æ•…éšœæ’æŸ¥
- **æ— æ•°æ®å…¥åº“**ï¼š
  - Sources æ˜¯å¦å‹¾ **Enabled**ï¼›FeedURL æ˜¯å¦å¯æ‰“å¼€è¿”å› XML
  - `Rules` çš„ **MIN_SCORE** æ˜¯å¦è¿‡é«˜ï¼ˆå…ˆè®¾ 2â€“3 æµ‹è¯•ï¼‰
  - Integration æ˜¯å¦æœ‰ **Can edit** æƒé™
- **é‡å¤/å™ªéŸ³å¤š**ï¼šæå‡ `NEGATIVE` æƒé‡å¹¶è®¾ **HardBlock=âœ…**ï¼›æé«˜ `MIN_SCORE`ï¼›æˆ–åœ¨ feed URL åŠ  `title_include/exclude`
- **WeWe ä¸æ›´æ–°**ï¼šç¡®è®¤ Zeabur çš„ `CRON_EXPRESSION` å·²ç”Ÿæ•ˆå¹¶ Redeployï¼›è®¿é—® `â€¦/feeds/all.atom?update=true` æµ‹è¯• 200

---

## ğŸ“ æœ¬åœ°è¿è¡Œï¼ˆå¯é€‰ï¼‰
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

export NOTION_TOKEN=secret_xxx
export NOTION_SOURCES_DB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_DB_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_RULES_DB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export NOTION_DAILY_PARENT=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

python -m src.pipeline
```

---

## ğŸ”’ å®‰å…¨
- **åˆ‡å‹¿**æŠŠ `secret_â€¦` token / æ•°æ®åº“ ID æ”¾åˆ°ä»£ç é‡Œï¼›åªæ”¾ **GitHub Secrets**ã€‚
- æ’¤é”€æƒé™ï¼šåœ¨ Notion **Connections** ç§»é™¤è¯¥ Integration æˆ–åœ¨é›†æˆé¡µé¢é‡ç½® tokenã€‚

---
